---
import { prepareURL } from "../lib/URL-helpers";

const navItems = [
  { label: "Platform", href: "/features" },
  { label: "Integrations", href: "/integrations" },
  { label: "Pricing", href: "/pricing" },
  { label: "Docs", href: "https://docs.epistola.app", external: true },
  { label: "Blog", href: "/blog" },
];

const logoHref = import.meta.env.BASE_URL;
const themeStorageKey = "epistola-theme";
---

<header class="fixed inset-x-0 top-0 z-50 border-b border-white/60 backdrop-blur-xl dark:border-white/10">
  <div class="absolute inset-0 bg-gradient-to-r from-[#fff8f4ee] via-[#f4f6ffee] to-[#f7f2ffee] dark:from-[#0e1224]/90 dark:via-[#090d1a]/90 dark:to-[#070914]/90"></div>
  <nav class="relative z-10 mx-auto flex h-20 max-w-6xl items-center justify-between px-4">
    <a href={logoHref} class="flex items-center gap-3">
      <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-[var(--color-accent-peach)]/80 text-[var(--color-brand-700)] font-semibold">
        E
      </div>
      <div class="flex flex-col">
        <span class="text-base font-semibold tracking-tight text-[var(--color-gray-700)] dark:text-white">
          Epistola
        </span>
        <span class="text-[10px] uppercase tracking-[0.35em] text-[var(--color-gray-400)]">Documents</span>
      </div>
    </a>
    <button
      id="nav-toggle"
      class="md:hidden flex h-11 w-11 items-center justify-center rounded-full border border-black/10 text-[var(--color-gray-700)] bg-white/70 dark:border-white/10 dark:bg-[rgba(18,23,39,0.8)] dark:text-white"
      aria-controls="mobile-nav"
      aria-expanded="false"
    >
      <span class="sr-only">Open navigation</span>
      <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h12M4 17h16" />
      </svg>
    </button>
    <div class="hidden items-center gap-8 text-sm font-medium text-[var(--color-gray-600)] dark:text-white/70 md:flex">
      {navItems.map((item) => {
        const href = item.external ? item.href : prepareURL(item.href);
        return (
          <a
            href={href}
            class="group relative pb-2 transition hover:text-[var(--color-brand-600)] dark:hover:text-[var(--color-accent-mint)]"
            target={item.external ? "_blank" : undefined}
            rel={item.external ? "noreferrer" : undefined}
          >
            {item.label}
            <span class="absolute inset-x-0 bottom-0 h-0.5 origin-left scale-x-0 bg-[var(--color-brand-500)] transition group-hover:scale-x-100" />
          </a>
        );
      })}
    </div>
    <div class="hidden items-center gap-3 md:flex">
      <button
        id="theme-toggle"
        class="flex h-10 w-10 items-center justify-center rounded-full border border-black/10 text-[var(--color-gray-700)] bg-white/70 transition hover:border-[var(--color-brand-500)] hover:text-[var(--color-brand-500)] dark:border-white/10 dark:bg-[rgba(18,23,39,0.8)] dark:text-white"
        aria-label="Toggle theme"
      >
        <span class="sr-only">Toggle theme</span>
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path
            id="theme-toggle-icon"
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 3.75A8.25 8.25 0 1 0 20.25 12 6.75 6.75 0 0 1 12 3.75z"
          />
        </svg>
      </button>
      <a
        href={prepareURL("/login")}
        class="rounded-full border border-black/10 px-4 py-2 text-sm font-semibold text-[var(--color-gray-700)] bg-white/70 hover:border-[var(--color-brand-200)] dark:border-white/15 dark:bg-[rgba(18,23,39,0.8)] dark:text-white"
      >
        Sign in
      </a>
      <a href="https://demo.epistola.app" class="cta-primary" target="_blank" rel="noreferrer">
        Open demo
      </a>
    </div>
    <div
      id="mobile-nav"
      class="fixed inset-y-0 right-0 z-50 hidden w-80 max-w-full bg-white/95 p-6 shadow-2xl dark:bg-[rgba(15,23,42,.98)] md:hidden"
    >
      <div class="flex items-center justify-between">
        <p class="text-sm font-semibold text-[var(--color-gray-600)]">Menu</p>
        <button
          id="nav-close"
          class="flex h-10 w-10 items-center justify-center rounded-full border border-black/10"
          aria-label="Close navigation"
        >
          <svg class="h-5 w-5" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none">
            <path stroke-linecap="round" stroke-linejoin="round" d="m6 6 12 12M18 6 6 18" />
          </svg>
        </button>
      </div>
      <div class="mt-8 flex flex-col gap-4 text-lg font-medium">
        {navItems.map((item) => {
          const href = item.external ? item.href : prepareURL(item.href);
          return (
            <a
              href={href}
              class="rounded-xl border border-black/5 px-4 py-3"
              target={item.external ? "_blank" : undefined}
              rel={item.external ? "noreferrer" : undefined}
            >
              {item.label}
            </a>
          );
        })}
      </div>
      <div class="mt-8 flex flex-col gap-3">
        <a href={prepareURL("/login")} class="cta-secondary text-center">
          Sign in
        </a>
        <a href="https://demo.epistola.app" class="cta-primary text-center" target="_blank" rel="noreferrer">
          Open demo
        </a>
      </div>
      <button
        id="theme-toggle-mobile"
        class="mt-8 inline-flex items-center gap-3 text-sm font-semibold text-[var(--color-gray-600)]"
      >
        <span>Toggle theme</span>
        <span class="relative h-6 w-12 rounded-full border border-black/10 p-0.5">
          <span id="theme-toggle-pill" class="block h-5 w-5 rounded-full bg-[var(--color-brand-600)] transition" />
        </span>
      </button>
    </div>
    <div id="scrim" class="fixed inset-0 z-40 hidden bg-black/30"></div>
  </nav>
</header>

<script>
  const storageKey = "{themeStorageKey}";
  const root = document.documentElement;
  const scrim = document.getElementById("scrim");
  const openBtn = document.getElementById("nav-toggle");
  const drawer = document.getElementById("mobile-nav");
  const closeBtn = document.getElementById("nav-close");
  const themeBtn = document.getElementById("theme-toggle");
  const themeBtnMobile = document.getElementById("theme-toggle-mobile");
  const pill = document.getElementById("theme-toggle-pill");
  const prefersDarkQuery = window.matchMedia('(prefers-color-scheme: dark)');

  const getStoredTheme = () => window.localStorage.getItem(storageKey);

  const applyTheme = (theme, persist = true) => {
    root.dataset.theme = theme;
    if (persist) {
      window.localStorage.setItem(storageKey, theme);
    }
    if (pill) {
      pill.style.transform = theme === "dark" ? "translateX(24px)" : "translateX(0)";
    }
  };

  const toggleTheme = () => {
    const next = root.dataset.theme === "dark" ? "light" : "dark";
    applyTheme(next, true);
  };

  const syncWithPreference = () => {
    const stored = getStoredTheme();
    if (stored) {
      applyTheme(stored, false);
    } else {
      applyTheme(prefersDarkQuery.matches ? "dark" : "light", false);
    }
  };

  themeBtn?.addEventListener("click", toggleTheme);
  themeBtnMobile?.addEventListener("click", toggleTheme);

  const openDrawer = () => {
    drawer?.classList.remove("hidden");
    scrim?.classList.remove("hidden");
    openBtn?.setAttribute("aria-expanded", "true");
    document.body.style.overflow = "hidden";
  };

  const closeDrawer = () => {
    drawer?.classList.add("hidden");
    scrim?.classList.add("hidden");
    openBtn?.setAttribute("aria-expanded", "false");
    document.body.style.overflow = "";
  };

  openBtn?.addEventListener("click", openDrawer);
  closeBtn?.addEventListener("click", closeDrawer);
  scrim?.addEventListener("click", closeDrawer);

  drawer?.querySelectorAll("a").forEach((link) =>
    link.addEventListener("click", closeDrawer)
  );

  const handleSystemThemeChange = (event) => {
    if (!getStoredTheme()) {
      applyTheme(event.matches ? "dark" : "light", false);
    }
  };

  if (typeof prefersDarkQuery.addEventListener === "function") {
    prefersDarkQuery.addEventListener("change", handleSystemThemeChange);
  } else if (typeof prefersDarkQuery.addListener === "function") {
    prefersDarkQuery.addListener(handleSystemThemeChange);
  }

  window.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      closeDrawer();
    }
  });

  syncWithPreference();
</script>
