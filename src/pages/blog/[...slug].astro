---
import { getCollection } from "astro:content";
import Layout from "../../components/layout.astro";
import { prepareURL } from "../../lib/URL-helpers";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const allPosts = await getCollection("blog");
const sortedPosts = allPosts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);
const relatedPosts = sortedPosts
  .filter((p) => p.slug !== post.slug)
  .slice(0, 3);

function formatDate(date: Date): string {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={post.data.cover}
>
  <article class="pt-32 pb-20">
    {
      post.data.cover && (
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 mb-8">
          <div class="max-w-5xl mx-auto">
            <div class="rounded-2xl overflow-hidden shadow-2xl">
              <img
                src={post.data.cover}
                alt={post.data.title}
                class="w-full h-[400px] md:h-[500px] object-cover"
              />
            </div>
          </div>
        </div>
      )
    }

    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-6xl mx-auto">
        <header class="mb-8">
          <div
            class="flex flex-wrap items-center gap-4 mb-4 text-sm text-gray-600 dark:text-gray-400"
          >
            <time datetime={post.data.date.toISOString()}>
              {formatDate(post.data.date)}
            </time>
            {
              post.data.updatedDate && (
                <>
                  <span>•</span>
                  <span>Updated {formatDate(post.data.updatedDate)}</span>
                </>
              )
            }
            <span>•</span>
            <span>By {post.data.author}</span>
          </div>
          <h1
            class="text-4xl md:text-5xl lg:text-6xl font-black mb-6 text-gray-900 dark:text-white leading-tight"
          >
            {post.data.title}
          </h1>
          <p
            class="text-xl md:text-2xl text-gray-600 dark:text-gray-300 mb-6 leading-relaxed"
          >
            {post.data.description}
          </p>
          {
            post.data.tags.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {post.data.tags.map((tag) => (
                  <span class="px-3 py-1 bg-accent-teal/10 dark:bg-accent-teal/20 text-accent-teal rounded-full text-sm font-medium">
                    {tag}
                  </span>
                ))}
              </div>
            )
          }
        </header>

        <div class="grid lg:grid-cols-5 gap-4">
          <div class="lg:col-span-4">
            <div class="prose prose-lg dark:prose-invert max-w-none">
              <Content />
            </div>

            <div
              class="mt-16 pt-16 border-t border-gray-200 dark:border-gray-700"
            >
              <a
                href={prepareURL("/blog")}
                class="inline-flex items-center gap-2 text-accent-teal dark:text-accent-green font-semibold hover:underline"
              >
                <span>←</span>
                Back to Blog
              </a>
            </div>

            {
              relatedPosts.length > 0 && (
                <div class="mt-16 pt-16 border-t border-gray-200 dark:border-gray-700">
                  <h2 class="text-3xl md:text-4xl font-bold mb-8 text-gray-900 dark:text-white">
                    Related Posts
                  </h2>
                  <div class="grid md:grid-cols-3 gap-6">
                    {relatedPosts.map((relatedPost) => (
                      <a
                        href={prepareURL("/blog/" + relatedPost.slug)}
                        class="group"
                      >
                        <article class="bg-white h-full dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-all">
                          {relatedPost.data.cover && (
                            <img
                              src={relatedPost.data.cover}
                              alt={relatedPost.data.title}
                              class="h-40 w-full object-cover group-hover:scale-105 transition-transform duration-300"
                            />
                          )}
                          <div class="p-5">
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                              {formatDate(relatedPost.data.date)}
                            </div>
                            <h3 class="text-lg font-bold mb-2 text-gray-900 dark:text-white group-hover:text-accent-teal transition-colors line-clamp-2">
                              {relatedPost.data.title}
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">
                              {relatedPost.data.description}
                            </p>
                          </div>
                        </article>
                      </a>
                    ))}
                  </div>
                </div>
              )
            }
          </div>

          <aside class="lg:col-span-1">
            <div class="sticky top-24">
              {
                headings.length > 0 && (
                  <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-lg">
                    <h3 class="text-base font-bold mb-4 text-gray-900 dark:text-white">
                      Table of Contents
                    </h3>
                    <nav class="text-xs">
                      <ul class="space-y-0">
                        {headings.map((heading) => (
                          <li class={`toc-item toc-h${heading.depth}`}>
                            <a
                              href={`#${heading.slug}`}
                              class="toc-link text-gray-600 dark:text-gray-400 hover:text-accent-teal dark:hover:text-accent-teal pl-2 border-l-4 rounded-sm border-transparent hover:border-accent-teal/50 hover:bg-accent-light/50 transition-colors duration-300 block py-1"
                            >
                              {heading.text}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </nav>
                  </div>
                )
              }
            </div>
          </aside>
        </div>
      </div>
    </div>
  </article>
</Layout>

<style is:global>
  .toc-h2 {
    padding-left: 0;
  }

  .toc-h3 {
    padding-left: 1rem;
  }

  .toc-h4 {
    padding-left: 2rem;
  }
</style>
